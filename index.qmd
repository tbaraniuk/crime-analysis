---
title: "Crime vs Evictions Analysis"
author: "Kristina Polonska, Mariana Konovalenko, Taras Baraniuk"
date: 10/21/2025
format:
    html: default
---

## Import Libraries
```{r}
#| message: false
#| warning: false
#| code-fold: true
#| code-summary: "show code"

if (!require("pacman")) install.packages("pacman")

pacman::p_load(
  arrow,
  tidyverse,
  lubridate,
  rvest,
  tidyr,
  plotly,
  scales,
  sf,
  janitor,
  stringr,
  patchwork,
  purrr
)
```


## Read the Data
```{r}
#| message: false

complaint_data <- read_csv("data/NYPD_Complaint_Data_Historic_20251019.csv")

complaint_data_full <- read_parquet("data/NYPD_Complaint_Data_Historic_20251021.parquet") |>
  clean_names()

evictions <- read_csv_arrow("data/Evictions_20251019.csv")

df_full_evictions <- read_csv_arrow("data/Evictions_20251021.csv") |>
  clean_names()
```


## Parse the Crime in Ukraine from Wikipedia
```{r}
url <- "https://uk.wikipedia.org/wiki/Злочинність_в_Україні"

page <- read_html(url)
tabs <- page |> 
  html_elements("table.wikitable")

crime_ukr <- tabs[[1]] |> 
  html_table(fill = TRUE)
```


## Preprocess the Data
```{r}
# Find out number of complaints each year: 
complaint_summary <- complaint_data |>
  mutate(
    date = mdy(CMPLNT_FR_DT), 
    year = year(date)
  ) |>
  filter(year >= 1900) |> 
  rename(
    NYC_district = BORO_NM
  )

# Group by year and borough and count numbers for each group
by_year_borough <- evictions |>
  mutate(
    exec_date = mdy(`Executed Date`),     
    year = year(exec_date),
    borough = toupper(BOROUGH)
  ) |> 
  count(year, borough, name = "n") |>
  arrange(year, borough) |>
  collect()

# Clean and process ukrainian crime rates data (add extra 2 missing rows):
crime_ukr <- crime_ukr |>
  rename(year = "рік") |>
  dplyr::filter(!is.na(year) & year >= 2010) |>
  mutate(
    total_crimes = str_replace_all(`всього злочинів`, "\\D", ""),
    total_crimes = na_if(total_crimes, ""),
    total_crimes = as.integer(total_crimes)
  ) |>
  select(year, total_crimes)

crime_ukr <- add_row(crime_ukr, year = 2024, total_crimes = 382335)
crime_ukr <- add_row(crime_ukr, year = 2025, total_crimes = 473662)
```


## Visualizations

### The Problem

The goal of our research is to suggest how government should remedy *rising crime rates in Ukraine*. We figured that *evictions highly affect crime rates*. We will take a look at what government of *New York City* has done in this area and how that helped lower number of crimes. Visualizations will help us see the patterns more clearly and confidently say which action helped.

### Rising Crime Rates In Ukraine
```{r}
#| code-fold: true
#| warning: false
#| code-summary: "show code"

ggplot(crime_ukr, aes(x = year, y = total_crimes / 1000)) +
  geom_line(color = "#A2B5CD", size = 1) +        
  geom_point(color = "#A2B5CD", size = 2) + 
  geom_text(
    aes(label = paste0(round(total_crimes / 1000, 0), "k")),
    vjust = -1.3,                     
    size = 3,                                   
    color = "black"
  ) +
  scale_x_continuous(breaks = crime_ukr$year) +
  labs(title = "Number of crimes commited each year in Ukraine (in thousands)",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(10, 20, 20, 20)
  )
```


### NYC Crime Complaints by Years
```{r}
#| code-fold: true
#| code-summary: "show code"

crime_year <- complaint_summary |>
  filter(!is.na(year), year >= 2000, year <= 2025) |>
  count(year, name = 'complaints') |>
  arrange(year)

complaint_vis <- ggplot(crime_year, aes(x = year, y = complaints, group = 1, text = paste0(
  'year: ', year,
  '\ncomplaints: ', comma(complaints)
))) +
  geom_line(color = '#2F539B', linewidth = 1) +
  scale_y_continuous(labels = comma) + 
  scale_x_continuous(breaks = pretty_breaks(n = 5)) +
  labs(
    title = 'NYC crime complaints by year',
    x = 'year', y = 'number of complaints'
  ) +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = '#F5F5F5'),
    panel.background = element_rect(fill = '#F5F5F5'),
    panel.grid.major.y = element_line(color = "#728FCE"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    text = element_text(face = 'italic')
  )

complaint_interactive <- ggplotly(complaint_vis, tooltip = 'text') |>
  layout(
    hovermode = 'x unified',
    yaxis = list(tickformat = ',d')
  )

complaint_interactive
```


### Total Counts of Evictions and Felonies (2016-2025)
```{r}
#| code-fold: true
#| code-summary: "show code"

eviction_monthly <- df_full_evictions |>
  select(borough, executed_date) |>
  mutate(executed_date = as_date(executed_date, format = "%m/%d/%Y")) |>
  filter(
    executed_date >= "2016-01-01" & executed_date <= "2025-12-31",
    !is.na(borough),
    borough != "Citywide"
  ) |>
  mutate(borough = str_to_title(borough)) |>
  mutate(
    month_year = floor_date(executed_date, "month")
  ) |>
  group_by(month_year) |>
  summarise(total_count = n()) |>
  collect() |>
  mutate(type = "Evictions")
 
crime_monthly <- complaint_data_full |>
  select(boro_nm, cmplnt_fr_dt, law_cat_cd) |>
  mutate(cmplnt_fr_dt = as_date(cmplnt_fr_dt, format = "%m/%d/%Y")) |>
  dplyr::filter(
    cmplnt_fr_dt >= "2016-01-01" & cmplnt_fr_dt <= "2025-12-31",
    !is.na(boro_nm),
    law_cat_cd == "FELONY"
  ) |>
  mutate(borough = str_to_title(boro_nm)) |>
  mutate(
    month_year = floor_date(cmplnt_fr_dt, "month")
  ) |>
  group_by(month_year) |>
  summarise(total_count = n()) |>
  collect() |>
  mutate(type = "Felonies")

bind_rows(eviction_monthly, crime_monthly) |>
  ggplot(aes(x = month_year, y = total_count, color = type)) +
    geom_line(linewidth = 1) +
    facet_wrap(~ type, ncol = 1, scales = "free_y") +
    scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
    scale_color_manual(values = c("Evictions" = "#1f78b4", "Felonies" = "#e31a1c")) +
    labs(
      title = paste("Total Monthly Evictions vs. Felonies in (2016-2025)"),
      x = "Date",
      y = "Total Count"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
```


### Hotspots for Evictions and Felonies over Years
```{r}
#| warning: false
#| code-fold: true
#| code-summary: "show code"

YEAR_START <- 2017
YEAR_END <- 2024

eviction_points_anim <- df_full_evictions |>
  select(borough, latitude, longitude, executed_date) |>
  mutate(
    executed_date = as_date(executed_date, format = "%m/%d/%Y"),
    year = year(executed_date)
  ) |>
  dplyr::filter(
    year >= YEAR_START & year <= YEAR_END, 
    !is.na(latitude), !is.na(longitude)
  ) |>
  mutate(
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
  ) |>
  dplyr::filter(
    latitude > 40.4 & latitude < 40.9,
    longitude > -74.3 & longitude < -73.6
  ) |>
  collect()

crime_points_anim <- complaint_data_full |>
  select(c(boro_nm, latitude, longitude, cmplnt_fr_dt, law_cat_cd)) |>
  mutate(
    cmplnt_fr_dt = as_date(cmplnt_fr_dt, format = "%m/%d/%Y"),
    year = year(cmplnt_fr_dt),
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
  ) |>
  dplyr::filter(
    year >= YEAR_START & year <= YEAR_END,
    law_cat_cd == "FELONY",
    !is.na(latitude), !is.na(longitude)
  ) |>
  dplyr::filter(
    latitude > 40.4 & latitude < 40.9,
    longitude > -74.3 & longitude < -73.6
  ) |>
  collect()

plot_evictions <- ggplot() +
  stat_density_2d(
    data = eviction_points_anim,
    aes(x = longitude, y = latitude, fill = ..level.., frame = year),
    geom = "polygon"
  ) +
  scale_fill_viridis_c(option = "magma") +
  theme_minimal() +
  theme(legend.position = "none")

plot_felonies <- ggplot() +
  stat_density_2d(
    data = crime_points_anim,
    aes(x = longitude, y = latitude, fill = ..level.., frame = year),
    geom = "polygon"
  ) +
  scale_fill_viridis_c(option = "magma") +
  theme_minimal() +
  theme(legend.position = "none")

fig <- plotly::subplot(
  ggplotly(plot_felonies), 
  ggplotly(plot_evictions),
  nrows = 1
) |>
  layout(title = "Eviction vs Felony Hotspots over Years")

fig
```


### What can we do to improve situation?

Lets look at the *how eviction rate changed* from 2017 to 2025 in each borough and *what changed* it.

```{r}
#| code-fold: true
#| code-summary: "show code"
#| warning: false

ggplot(by_year_borough, aes(x = year, y = n, color = borough, group = borough)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_x_continuous(
    breaks = unique(by_year_borough$year)
  ) + 
  labs(
    title = "Evictions by borough",
    x = NULL,
    y = "Number of evictions"
  ) +
  scale_color_brewer(palette = "RdYlBu") +
  geom_vline(xintercept = 2019, color = "#FF6347", linetype = "dashed", linewidth = 0.8) +
  annotate("text", x = 2019, 
           y = max(by_year_borough$n) * 1.05,   
           label = "HSTPA", 
           size = 4, color = "#FF6347", fontface = "bold") +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    plot.margin = margin(10, 20, 10, 10),   
    clip = "off"  
  )
```






